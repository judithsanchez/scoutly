classDef default fill:#2d333b,stroke:#adbac7,stroke-width:1px,color:#adbac7
classDef process fill:#22272e,stroke:#adbac7,stroke-width:1px,color:#adbac7
classDef storage fill:#1d2229,stroke:#adbac7,stroke-width:1px,color:#adbac7
classDef special fill:#2d2b55,stroke:#adbac7,stroke-width:1px,color:#adbac7
classDef important fill:#3e3426,stroke:#d4a75f,stroke-width:1px,color:#d4a75f

flowchart TD
    subgraph "Phase 2: Automation Engine"
        direction TB
        
        subgraph "Scheduler System"
            CRON[Cron Job / Timer]:::important
            SCHEDULER[Scheduler.ts]:::process
            COOLDOWN{Cooldown Check}:::process
        end
        
        subgraph "Queue Management" 
            QUEUE[(JobQueue Collection)]:::storage
            PENDING[PENDING Jobs]:::default
            PROCESSING[PROCESSING Jobs]:::default
            COMPLETED[COMPLETED Jobs]:::default
            FAILED[FAILED Jobs]:::default
        end
        
        subgraph "Worker System"
            WORKER[Worker.ts]:::process
            PIPELINE[Job Matching Pipeline]:::important
            PIPELINE_EXEC[Pipeline Execution]:::process
        end
        
        subgraph "Data Sources"
            USER_PREFS[(UserCompanyPreference)]:::storage
            COMPANIES[(Company Collection)]:::storage
            USERS[(User Collection)]:::storage
        end
        
        subgraph "Monitoring & Logging"
            DB_LOGS[(Database Logs)]:::storage
            QUEUE_STATUS[Queue Status Script]:::process
            DOCKER_LOGS[Docker Logs Stream]:::special
        end
    end
    
    %% Scheduler Flow
    CRON --> SCHEDULER
    SCHEDULER --> USER_PREFS
    SCHEDULER --> COMPANIES
    SCHEDULER --> COOLDOWN
    COOLDOWN -->|"Cooldown Passed"| QUEUE
    COOLDOWN -->|"Too Recent"| END1[Skip Company]:::default
    
    %% Queue Management
    QUEUE --> PENDING
    PENDING --> PROCESSING
    PROCESSING --> COMPLETED
    PROCESSING --> FAILED
    
    %% Worker Flow  
    WORKER -->|"Poll for Jobs"| PENDING
    PENDING -->|"Atomic Update"| PROCESSING
    PROCESSING --> WORKER
    WORKER --> USERS
    WORKER --> COMPANIES
    WORKER --> PIPELINE
    PIPELINE --> PIPELINE_EXEC
    PIPELINE_EXEC -->|"Success"| COMPLETED
    PIPELINE_EXEC -->|"Error"| FAILED
    
    %% Monitoring
    SCHEDULER --> DB_LOGS
    WORKER --> DB_LOGS
    PIPELINE --> DB_LOGS
    QUEUE_STATUS --> QUEUE
    DOCKER_LOGS --> QUEUE_STATUS
    
    %% Cooldown Logic Details
    COOLDOWN --> RANK_95[Rank ≥95: 12h]:::important
    COOLDOWN --> RANK_85[Rank ≥85: 24h]:::process
    COOLDOWN --> RANK_70[Rank ≥70: 48h]:::process
    COOLDOWN --> RANK_50[Rank ≥50: 7d]:::default
    COOLDOWN --> RANK_LOW[Rank <50: 14d]:::default
