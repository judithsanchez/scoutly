%%{init: {'theme': 'dark'}}%%
sequenceDiagram
    participant C as Client
    participant JE as Jobs Endpoint
    participant JMO as JobMatchingOrchestrator
    participant S as Scraper
    participant DB as Database
    participant AI as Gemini AI

    C->>+JE: POST /api/jobs
    Note over C,JE: Request with:<br/>- Companies: Google, Microsoft, Amazon<br/>- CV URL<br/>- Candidate Info

    JE->>DB: Verify User
    JE->>+JMO: Initialize Orchestrator

    par Parallel Scraping - Step 1
        JMO->>+S: Scrape Google Careers Page
        S-->>-JMO: 50 links (mix of jobs, nav, etc.)
        
        JMO->>+S: Scrape Microsoft Careers Page
        S-->>-JMO: 40 links (mix of jobs, nav, etc.)
        
        JMO->>+S: Scrape Amazon Careers Page
        S-->>-JMO: 60 links (mix of jobs, nav, etc.)
    end

    par Parallel Link Filtering - Step 2
        JMO->>+DB: Filter Google Links
        DB-->>-JMO: 12 new jobs
        
        JMO->>+DB: Filter Microsoft Links
        DB-->>-JMO: 8 new jobs
        
        JMO->>+DB: Filter Amazon Links
        DB-->>-JMO: 15 new jobs
    end

    Note over JMO: Combined 150 links to analyze

    JMO->>+AI: Initial Job Matching
    Note over JMO,AI: Single AI call to:<br/>1. Filter actual job postings<br/>2. Match against CV & profile
    AI-->>-JMO: Identified & Matched Jobs:<br/>- Google: 12 job matches<br/>- Microsoft: 8 job matches<br/>- Amazon: 15 job matches<br/>(Rest were nav links, login, etc.)

    Note over JMO: Process Google's 12 jobs

    par Google Job Details - Batch 1
        JMO->>+S: Get Senior Engineer details
        JMO->>+S: Get Tech Lead details
        JMO->>+S: Get Software Dev details
        S-->>-JMO: Job Content 1
        S-->>-JMO: Job Content 2
        S-->>-JMO: Job Content 3
    end

    JMO->>+AI: Deep Dive - Google Batch 1
    Note over JMO,AI: Analyze first 5 Google jobs
    AI-->>-JMO: Analysis Results 1-5
    JMO->>DB: Save Results 1-5

    par Google Job Details - Batch 2
        JMO->>+S: Get next 3 job details
        S-->>-JMO: Job Contents 4-6
    end

    JMO->>+AI: Deep Dive - Google Batch 2
    Note over JMO,AI: Analyze next 5 Google jobs
    AI-->>-JMO: Analysis Results 6-10
    JMO->>DB: Save Results 6-10

    par Google Job Details - Final
        JMO->>+S: Get last 2 job details
        S-->>-JMO: Job Contents 11-12
    end

    JMO->>+AI: Deep Dive - Google Final
    Note over JMO,AI: Analyze last 2 Google jobs
    AI-->>-JMO: Analysis Results 11-12
    JMO->>DB: Save Results 11-12

    Note over JMO: Process Microsoft's 8 jobs

    par Microsoft Job Details - Batch 1
        JMO->>+S: Get 3 job details
        S-->>-JMO: Job Contents 1-3
    end

    JMO->>+AI: Deep Dive - Microsoft Batch 1
    Note over JMO,AI: Analyze first 5 Microsoft jobs
    AI-->>-JMO: Analysis Results 1-5
    JMO->>DB: Save Results 1-5

    par Microsoft Job Details - Final
        JMO->>+S: Get last 3 job details
        S-->>-JMO: Job Contents 6-8
    end

    JMO->>+AI: Deep Dive - Microsoft Final
    Note over JMO,AI: Analyze last 3 Microsoft jobs
    AI-->>-JMO: Analysis Results 6-8
    JMO->>DB: Save Results 6-8

    Note over JMO: Process Amazon's 15 jobs
    Note over JMO: (Similar pattern with 3 AI batches)

    JMO-->>-JE: Complete Results
    JE-->>-C: JSON Response
    Note over C,JE: All analyzed jobs with scores
