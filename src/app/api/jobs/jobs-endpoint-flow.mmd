%%{init: {'theme': 'dark'}}%%
sequenceDiagram
    participant C as Client
    participant JE as Jobs Endpoint
    participant JMO as JobMatchingOrchestrator
    participant S as Scraper
    participant DB as Database
    participant AI as Gemini AI

    C->>+JE: POST /api/jobs
    Note over C,JE: Sends credentials, companyIds,<br/>cvUrl, candidateInfo

    JE->>DB: Verify/Create User
    JE->>+JMO: Initialize Orchestrator

    Note over JE,JMO: Can process up to 10 companies in parallel
    
    par Parallel company scraping
        loop For each company (max 10)
            JMO->>+S: Scrape Company Careers Page
            S-->>-JMO: Return Page Content & All Links
            Note over S,JMO: Returns everything found:<br/>- Job links<br/>- Navigation links<br/>- Login/signup links<br/>- Cookie/privacy links<br/>etc.
            
            JMO->>+DB: Find New Links
            Note over JMO,DB: Compare with previously<br/>scraped links history
            DB-->>-JMO: Return filtered new links
        end
    end

    Note over JMO: Combine all scraped links<br/>from all companies
    
    JMO->>+AI: Single Initial Job Matching Call
    Note over JMO,AI: 1. Filter actual job postings<br/>2. Match against CV & candidate profile<br/>One call for all companies
    AI-->>-JMO: Return Actual Job Posts<br/>that Match Profile
    
    Note over JMO: Group matched jobs by company

    loop For each company with matches
        Note over JMO: Process matched jobs for company
        
        loop For matched jobs in batches (max 3 parallel)
            JMO->>+S: Scrape Job Details
            S-->>-JMO: Return Job Content
        end

        loop Jobs analyzed in batches of 5
            JMO->>+AI: Deep Dive Analysis
            Note over JMO,AI: Detailed analysis of job content<br/>including fit scoring<br/>Max 5 jobs per AI call
            AI-->>-JMO: Return Analysis Results

            JMO->>DB: Save Analyzed Jobs
            Note over JMO,DB: Store jobs with scores<br/>and analysis details
        end
    end

    JMO-->>-JE: Return Results
    JE-->>-C: JSON Response
    Note over C,JE: Contains analyzed jobs<br/>with suitability scores
